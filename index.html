<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>苟利国家生死已 岂因祸福避趋之</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="苟利国家生死已 岂因祸福避趋之">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="苟利国家生死已 岂因祸福避趋之">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="苟利国家生死已 岂因祸福避趋之">
  
    <link rel="alternative" href="/atom.xml" title="苟利国家生死已 岂因祸福避趋之" type="application/atom+xml">
  
  
    <link rel="icon" href="https://avatars2.githubusercontent.com/u/5449200?v=3&s=460">
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">fkaking</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/fkaking" title="github">github</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">fkaking</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="null" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">fkaking</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/fkaking" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-ButterKnife-源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/21/ButterKnife-源码分析/">ButterKnife 源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>相信现在所有做安卓开发的朋友没有没听说过<a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="external">ButterKnife</a>这个库的吧。一个由大名鼎鼎的Square公司的更大名鼎鼎的JakeWharton开发的一个基于注解的注入库。可以帮助我们省去烦人的findViewById和setOnclickListener等模板代码。具体用法不细讲了，有需要的朋友可以去查阅官方文档，今天主要来分析下它的代码和执行流程。</p>
<p>首先下载源码并打开后，可以看到整个工程的组织结构。主要的模块有三个，分别是butterknife、butterknife-annotations、butterknife-compiler，另外还有几个库分别是test和lint（说到这不得不佩服老外做开源的精神。。。）今天主要做的分析就是针对这三个模块。我们一个个来。</p>
<h1 id="ButterKnife"><a href="#ButterKnife" class="headerlink" title="ButterKnife"></a>ButterKnife</h1><p>这个模块是使用butterknife的用户直接使用的。比如我们在Activity里bindview，那就要调用一个ButterKnife.bind(this)方法。只要有了这句，就可以开始搞黑科技了。那么bind方法到底做了什么呢？上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">  View sourceView = target.getWindow().getDecorView();</div><div class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bind方法里调用了createBinding()，那么来看看createBinding()都干了啥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</div><div class="line">  Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">  <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</div><div class="line">  Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> Unbinder.EMPTY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> constructor.newInstance(target, source);</div><div class="line">  &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">  &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">  &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">    Throwable cause = e.getCause();</div><div class="line">    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">      <span class="keyword">throw</span> (RuntimeException) cause;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">      <span class="keyword">throw</span> (Error) cause;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create binding instance."</span>, cause);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，该方法里只做了一件事，那就是找到对应Activity的binding对象的constructor方法，并且通过反射创建一个binding对象实例出来。那么Constructor对象又是怎么来的呢？我们来看findBindingConstructorForClass这个方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Nullable @CheckResult @UiThread</div><div class="line">private static Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</div><div class="line">  Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</div><div class="line">  if (bindingCtor != null) &#123;</div><div class="line">    if (debug) Log.d(TAG, &quot;HIT: Cached in binding map.&quot;);</div><div class="line">    return bindingCtor;</div><div class="line">  &#125;</div><div class="line">  String clsName = cls.getName();</div><div class="line">  if (clsName.startsWith(&quot;android.&quot;) || clsName.startsWith(&quot;java.&quot;)) &#123;</div><div class="line">    if (debug) Log.d(TAG, &quot;MISS: Reached framework class. Abandoning search.&quot;);</div><div class="line">    return null;</div><div class="line">  &#125;</div><div class="line">  try &#123;</div><div class="line">    Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + &quot;_ViewBinding&quot;);</div><div class="line">    //noinspection unchecked</div><div class="line">    bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</div><div class="line">    if (debug) Log.d(TAG, &quot;HIT: Loaded binding class and constructor.&quot;);</div><div class="line">  &#125; catch (ClassNotFoundException e) &#123;</div><div class="line">    if (debug) Log.d(TAG, &quot;Not found. Trying superclass &quot; + cls.getSuperclass().getName());</div><div class="line">    bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</div><div class="line">  &#125; catch (NoSuchMethodException e) &#123;</div><div class="line">    throw new RuntimeException(&quot;Unable to find binding constructor for &quot; + clsName, e);</div><div class="line">  &#125;</div><div class="line">  BINDINGS.put(cls, bindingCtor);</div><div class="line">  return bindingCtor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先到BINDINGS这个缓存map里寻找对应class的constructor对象，如果没有找到，则通过反射去创建。但由于反射对性能有一定影响，所以在首次反射成功后，就把结果放到缓存里。<code>Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + &quot;_ViewBinding&quot;);</code>可以看到对应的bingview类的名字是原Activity的名字加上<code>_ViewBinding</code>构成的。这一点可以从我们编译后的代码里验证。打开app/build/generated/apt目录，可以看到所有我们注入的类在这里都有一个对应的’_ViewBinding’的java文件。这个文件就是butterknife通过apt自动生成的代码。</p>
<p>那么这个_ViewBinding文件里到底做了些什么呢？我们打开一个看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class SearchActivity_ViewBinding&lt;T extends SearchActivity&gt; implements Unbinder &#123;</div><div class="line">  protected T target;</div><div class="line"></div><div class="line">  private View view2131690696;</div><div class="line"></div><div class="line">  @UiThread</div><div class="line">  public SearchActivity_ViewBinding(final T target, View source) &#123;</div><div class="line">    this.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    target.defaultView = Utils.findRequiredViewAsType(source, R.id.default_view, &quot;field &apos;defaultView&apos;&quot;, RelativeLayout.class);</div><div class="line">    view = Utils.findRequiredView(source, R.id.create_record, &quot;method &apos;onClick&apos;&quot;);</div><div class="line">    view2131690696 = view;</div><div class="line">    view.setOnClickListener(new DebouncingOnClickListener() &#123;</div><div class="line">      @Override</div><div class="line">      public void doClick(View p0) &#123;</div><div class="line">        target.onClick();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  @CallSuper</div><div class="line">  public void unbind() &#123;</div><div class="line">    T target = this.target;</div><div class="line">    if (target == null) throw new IllegalStateException(&quot;Bindings already cleared.&quot;);</div><div class="line"></div><div class="line">    target.defaultView = null;</div><div class="line"></div><div class="line">    view2131690696.setOnClickListener(null);</div><div class="line">    view2131690696 = null;</div><div class="line"></div><div class="line">    this.target = null;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原来就是一个实现了Unbinder接口的类。Unbinder接口只有一个unbind方法，主要工作是把注入的元素和监听事件解绑，比较简单。重点来看这个类的构造方法。首先我们可以看到一个名为target的成员变量，这个通过上下文我们可以猜到它就是我们被注入的Activity对象。构造方法里执行了几个赋值的语句，因为我在原Activity的defaultView这个变量上添加了注解，那么这里给activity.targetView赋值，就是所谓的注入过程。这也就解释了为什么被注解标识的元素不能用private修饰的原因。</p>
<p>其实说到这，我们基本上就看懂ButterKnife的实现原理了。首先，当我们在开发过程中对某些元素添加注解后，进行编译，编译的过程中ButterKnife会生成对应的_ViewBinding的源文件，然后在代码运行过程中，通过调用ButterKnife.bind()方法，创建一个viewbinding对象（首次创建是反射的方式），这个viewbinding对象的构造方法里就执行了注入。所以在创建对象的过程中也就是执行bind方法时，就为Activity里的变量完成了注入。此时，我们就可以随心所欲的使用声明了的view变量了，省去了为view手动赋值的过程。</p>
<p>是不是很简单？哈哈，说起来简单，其实背后的工作很复杂。比如刚才说到ButterKnife自动生成源文件，这其实是个很繁琐的过程，别急，一会儿会讲到。</p>
<h2 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h2><p>在讲生成源代码之前，我们先来了解下注解这个东西。java的注解位于java.lang.annotation包下。</p>
<p>ButterKnife里定义了很多注解，我们找一个来看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Retention(CLASS) @Target(FIELD)</div><div class="line">public @interface BindView &#123;</div><div class="line">  /** View ID to which the field will be bound. */</div><div class="line">  @IdRes int value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是我们最常用的BindView注解，它的定义如上。</p>
<p>注解用@interface来表示。在上面还有@Retention和@Target</p>
<ul>
<li>@Retention 表示注解存在的生命周期。它有三个对应值，分别是SOURCE（源码期）、CLASS（编译期）、RUNTIME（运行期）。</li>
<li>@Target 表示该注解可以用来修饰哪些元素。这里FILED表示所有的成员变量都可以使用这个注解。</li>
</ul>
<p>接口还定义了一个value方法，返回的是对应view的id，也就是我们在写注解时@BindView(R.id.**)括号里的内容。</p>
<h2 id="Annotation-Processor"><a href="#Annotation-Processor" class="headerlink" title="Annotation Processor"></a>Annotation Processor</h2><p>注解有了，我们也知道工作原理了，那么目前还有一个问题没搞清楚，butterknife是怎么创造出这些源文件的呢？而且里面还是标准的java代码！这就不得不请另一位重量级嘉宾出场了——Annotation Processor。也就是注解处理器。注解处理器是<strong>javac</strong>的一个工具，它用来在编译时扫描和处理注解（Annotation）。你可以对自定义注解，并注册相应的注解处理器。到这里，我们已经知道什么是注解，并且知道怎么申明的一个注解。如果相对注解有更深入的了解，你可以在这<a href="http://docs.oracle.com/javase/tutorial/java/annotations/index.html" target="_blank" rel="external">官方文档</a>中得到更多信息。注解处理器在Java 5开始就有了，但是从Java 6（2006年12月发布）开始才有可用的API。过了一些时间，Java世界才意识到注解处理器的强大作用，所以它到最近几年才流行起来。</p>
<p>一个注解的注解处理器，以Java代码（或者编译过的字节码）作为输入，生成文件（通常是<code>.java</code>文件）作为输出。这具体的含义什么呢？你可以生成Java代码！这些生成的Java代码是在生成的.java文件中，所以你不能修改已经存在的Java类，例如向已有的类中添加方法。这些生成的Java文件，会同其他普通的手动编写的Java源代码一样被<strong>javac</strong>编译。</p>
<p>ButterKnife为了实现注入功能，为每一个含有注解的类都自动生成了一份_ViewBinding文件，为此也定义了自己的Annotation Processor。其代码位于butterknife/butterknife-compiler/src/main/java/butterknife/compiler/ButterKnifeProcessor.java。</p>
<p>具体应该如何实现一个Processor这里不展开讲，有时间专门写一篇。我们只关注它的核心部分：process方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Override public boolean process(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env) &#123;</div><div class="line">  Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</div><div class="line"></div><div class="line">  for (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">    TypeElement typeElement = entry.getKey();</div><div class="line">    BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">    JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">    try &#123;</div><div class="line">      javaFile.writeTo(filer);</div><div class="line">    &#125; catch (IOException e) &#123;</div><div class="line">      error(typeElement, &quot;Unable to write binding for type %s: %s&quot;, typeElement, e.getMessage());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>总体来看 <code>process</code> 方法就干了两件事情：</p>
<ol>
<li>扫描所有的注解，然后生成以 <code>TypeElement</code> 为 key ，<code>BindingSet</code> 为 value 的 Map ；</li>
<li>根据生成的 Map ，遍历后通过 Filter 来生成对应的辅助类源码。PS：<a href="http://yuqirong.me/2016/12/18/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" target="_blank" rel="external">ButterKnife</a> 使用了 <a href="https://github.com/square/javapoet" target="_blank" rel="external">JavaPoet</a> 来生成 Java 源码。如果对 <a href="https://github.com/square/javapoet" target="_blank" rel="external">JavaPoet</a> 不太熟悉，可以先阅读这篇文章 <a href="http://www.jianshu.com/p/95f12f72f69a" target="_blank" rel="external">《javapoet——让你从重复无聊的代码中解放出来》</a> 。</li>
</ol>
<p>先来分析一下 <code>findAndParseTargets(env)</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// 扫描所有的ButterKnife注解，并且生成以TypeElement为键，BindingSet为值的HashMap</div><div class="line">private Map&lt;TypeElement, BindingSet&gt; findAndParseTargets(RoundEnvironment env) &#123;</div><div class="line">	Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = new LinkedHashMap&lt;&gt;();</div><div class="line">	Set&lt;TypeElement&gt; erasedTargetNames = new LinkedHashSet&lt;&gt;();</div><div class="line">	</div><div class="line">	scanForRClasses(env);</div><div class="line"></div><div class="line">	// Process each @BindView element.</div><div class="line">	// 遍历所有被 @BindView 标注的元素</div><div class="line">	for (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">	  // we don&apos;t SuperficialValidation.validateElement(element)</div><div class="line">	  // so that an unresolved View type can be generated by later processing rounds</div><div class="line">	  try &#123;</div><div class="line">	    parseBindView(element, builderMap, erasedTargetNames);</div><div class="line">	  &#125; catch (Exception e) &#123;</div><div class="line">	    logParsingError(element, BindView.class, e);</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	... </div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先来看关于 <code>BindView</code> 的那个 for 循环，它会遍历所有被 <code>@BindView</code> 注解的属性，然后调用 <code>parseBindView</code>方法。那么我们就先看到 <code>findAndParseTargets</code> 的前半段，一起跟进 <code>parseBindView</code> 的方法中去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">private void parseBindView(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</div><div class="line">    Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">  TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">  // Start by verifying common generated code restrictions.</div><div class="line">  boolean hasError = isInaccessibleViaGeneratedCode(BindView.class, &quot;fields&quot;, element)</div><div class="line">      || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">  // Verify that the target type extends from View.</div><div class="line">  TypeMirror elementType = element.asType();</div><div class="line">  if (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">    TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">    elementType = typeVariable.getUpperBound();</div><div class="line">  &#125;</div><div class="line">  Name qualifiedName = enclosingElement.getQualifiedName();</div><div class="line">  Name simpleName = element.getSimpleName();</div><div class="line">  if (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">    if (elementType.getKind() == TypeKind.ERROR) &#123;</div><div class="line">      note(element, &quot;@%s field with unresolved type (%s) &quot;</div><div class="line">              + &quot;must elsewhere be generated as a View or interface. (%s.%s)&quot;,</div><div class="line">          BindView.class.getSimpleName(), elementType, qualifiedName, simpleName);</div><div class="line">    &#125; else &#123;</div><div class="line">      error(element, &quot;@%s fields must extend from View or be an interface. (%s.%s)&quot;,</div><div class="line">          BindView.class.getSimpleName(), qualifiedName, simpleName);</div><div class="line">      hasError = true;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (hasError) &#123;</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Assemble information on the field.</div><div class="line">  int id = element.getAnnotation(BindView.class).value();</div><div class="line"></div><div class="line">  BindingSet.Builder builder = builderMap.get(enclosingElement);</div><div class="line">  QualifiedId qualifiedId = elementToQualifiedId(element, id);</div><div class="line">  if (builder != null) &#123;</div><div class="line">    String existingBindingName = builder.findExistingBindingName(getId(qualifiedId));</div><div class="line">    if (existingBindingName != null) &#123;</div><div class="line">      error(element, &quot;Attempt to use @%s for an already bound ID %d on &apos;%s&apos;. (%s.%s)&quot;,</div><div class="line">          BindView.class.getSimpleName(), id, existingBindingName,</div><div class="line">          enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">      return;</div><div class="line">    &#125;</div><div class="line">  &#125; else &#123;</div><div class="line">    builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  String name = simpleName.toString();</div><div class="line">  TypeName type = TypeName.get(elementType);</div><div class="line">  boolean required = isFieldRequired(element);</div><div class="line"></div><div class="line">  builder.addField(getId(qualifiedId), new FieldViewBinding(name, type, required));</div><div class="line"></div><div class="line">  // Add the type-erased version to the valid binding targets set.</div><div class="line">  erasedTargetNames.add(enclosingElement);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先对每个element做了类型校验，然后去创建bindingbuilder。builder中有相应的变量信息，后面会用到这些信息去生成代码。</p>
<p>接下来我们继续看findAndParseTargets方法的后半段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">private Map&lt;TypeElement, BindingSet&gt; findAndParseTargets(RoundEnvironment env) &#123;</div><div class="line"></div><div class="line">	... // 省略前半部分源码</div><div class="line"></div><div class="line">	// Associate superclass binders with their subclass binders. This is a queue-based tree walk</div><div class="line">	// which starts at the roots (superclasses) and walks to the leafs (subclasses).</div><div class="line">	Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</div><div class="line">	    new ArrayDeque&lt;&gt;(builderMap.entrySet());</div><div class="line">	Map&lt;TypeElement, BindingSet&gt; bindingMap = new LinkedHashMap&lt;&gt;();</div><div class="line">	while (!entries.isEmpty()) &#123;</div><div class="line">	  // 一个个取出遍历</div><div class="line">	  Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</div><div class="line">	  // 得到对应的 key 和 value</div><div class="line">	  TypeElement type = entry.getKey();</div><div class="line">	  BindingSet.Builder builder = entry.getValue();</div><div class="line">	  // 找到该类元素的父元素</div><div class="line">	  TypeElement parentType = findParentType(type, erasedTargetNames);</div><div class="line">	  if (parentType == null) &#123;</div><div class="line">	    // 生成 BindingSet ，放入 Map 中</div><div class="line">	    bindingMap.put(type, builder.build());</div><div class="line">	  &#125; else &#123;</div><div class="line">	    BindingSet parentBinding = bindingMap.get(parentType);</div><div class="line">	    if (parentBinding != null) &#123;</div><div class="line">	      // 设置父元素的 BindingSet</div><div class="line">	      builder.setParent(parentBinding);</div><div class="line">	      bindingMap.put(type, builder.build());</div><div class="line">	    &#125; else &#123;</div><div class="line">	      // Has a superclass binding but we haven&apos;t built it yet. Re-enqueue for later.</div><div class="line">	      // 有父元素，但是父元素的 BindingSet 还没有被 build 出来，</div><div class="line">	      // 所以再放入 entries 中等待遍历 </div><div class="line">	      entries.addLast(entry);</div><div class="line">	    &#125;</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">	// 解析结果都会存放在 bindingMap 中</div><div class="line">	return bindingMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>findAndParseTargets(env)</code> 方法的后半段中，主要就是把之前的 <code>builderMap</code> 转换为了 <code>bindingMap</code> 并返回。</p>
<p>到了这里，我们把 <code>process(Set elements, RoundEnvironment env)</code> 做的第一件事情搞清楚了，下面就接着来看第二件事情了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 遍历 bindingMap 并且通过 Filer 生成 Java 代码</div><div class="line">for (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">  TypeElement typeElement = entry.getKey();</div><div class="line">  BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">  JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">  try &#123;</div><div class="line">    javaFile.writeTo(filer);</div><div class="line">  &#125; catch (IOException e) &#123;</div><div class="line">    error(typeElement, &quot;Unable to write binding for type %s: %s&quot;, typeElement, e.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="brewJava-int-sdk"><a href="#brewJava-int-sdk" class="headerlink" title="brewJava(int sdk)"></a>brewJava(int sdk)</h2><p>从上面可以看到，遍历了之前得到的 <code>bindingMap</code> ，然后利用 <code>binding</code> 中的信息生成相应的 Java 源码。所以在 <code>binding.brewJava(sdk)</code> 这个方法是我们重点关注对象。那么就进入 <code>BindingSet</code> (路径：butterknife-compiler/butterknife/compiler/BindingSet.java) 这个类中去看看吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">JavaFile brewJava(int sdk) &#123;</div><div class="line">    // 生成 JavaFile，添加相应的注释</div><div class="line">    return JavaFile.builder(bindingClassName.packageName(), createType(sdk))</div><div class="line">            .addFileComment(&quot;Generated code from Butter Knife. Do not modify!&quot;)</div><div class="line">            .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>brewJava(int sdk)</code> 方法的代码竟然这么短 O_o ，就是利用了 <code>JavaFile.builder</code> 生成了一个 <code>JavaFile</code> 对象而已。但是我们发现其中有一个 <code>createType(int sdk)</code> 方法，隐隐约约感觉一定是这个方法在搞大事情。继续跟进去看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private TypeSpec createType(int sdk) &#123;</div><div class="line">    // 生成类名为 bindingClassName 的公共类，比如 MainActivity_ViewBinding</div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</div><div class="line">            .addModifiers(PUBLIC);</div><div class="line">    // 是否修饰为 final ，默认是 false</div><div class="line">    if (isFinal) &#123;</div><div class="line">        result.addModifiers(FINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (parentBinding != null) &#123;</div><div class="line">        // 如果有父类的话，那么要继承父类</div><div class="line">        result.superclass(parentBinding.bindingClassName);</div><div class="line">    &#125; else &#123;</div><div class="line">        // 如果没有父类，那么实现 Unbinder 接口</div><div class="line">        result.addSuperinterface(UNBINDER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 增加一个变量名为target，类型为targetTypeName的成员变量</div><div class="line">    if (hasTargetField()) &#123;</div><div class="line">        result.addField(targetTypeName, &quot;target&quot;, PRIVATE);</div><div class="line">    &#125;</div><div class="line">    // 如果没有 View 绑定</div><div class="line">    if (!constructorNeedsView()) &#123;</div><div class="line">        // Add a delegating constructor with a target type + view signature for reflective use.</div><div class="line">        // 该生成的构造方法被 @deprecated ，一般作为反射使用</div><div class="line">        result.addMethod(createBindingViewDelegateConstructor(targetTypeName));</div><div class="line">    &#125;</div><div class="line">    // 生成构造方法，另外 findViewById 类似的代码都在这里生成</div><div class="line">    // Xxxx_ViewBinding 一般都是执行这个方法生成构造器</div><div class="line">    result.addMethod(createBindingConstructor(targetTypeName, sdk));</div><div class="line"></div><div class="line">    if (hasViewBindings() || parentBinding == null) &#123;</div><div class="line">        //生成unBind方法</div><div class="line">        result.addMethod(createBindingUnbindMethod(result, targetTypeName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>createType(int sdk)</code> 方法中，基本构建好了一个类的大概，其中对于构造器以及类似 <code>findViewById</code> 的操作都是在 <code>createBindingConstructor(targetTypeName, sdk)</code> 中实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">private MethodSpec createBindingConstructor(TypeName targetType, int sdk) &#123;</div><div class="line">    // 创建构造方法，方法修饰符为 public ，并且添加注解为UiThread</div><div class="line">    MethodSpec.Builder constructor = MethodSpec.constructorBuilder()</div><div class="line">            .addAnnotation(UI_THREAD)</div><div class="line">            .addModifiers(PUBLIC);</div><div class="line">    // 如果有方法绑定，比如 @OnClick</div><div class="line">    if (hasMethodBindings()) &#123;</div><div class="line">        // 如果有，那么添加 targetType 类型，final 修饰，参数名为 target 的构造方法参数</div><div class="line">        constructor.addParameter(targetType, &quot;target&quot;, FINAL);</div><div class="line">    &#125; else &#123;</div><div class="line">        // 如果没有，和上面比起来就少了一个 final 修饰符</div><div class="line">        constructor.addParameter(targetType, &quot;target&quot;);</div><div class="line">    &#125;</div><div class="line">    // 如果有注解的 View</div><div class="line">    if (constructorNeedsView()) &#123;</div><div class="line">        // 那么添加 View source 参数</div><div class="line">        constructor.addParameter(VIEW, &quot;source&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">        // 否则添加 Context context 参数</div><div class="line">        constructor.addParameter(CONTEXT, &quot;context&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (hasUnqualifiedResourceBindings()) &#123;</div><div class="line">        // Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</div><div class="line">        constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</div><div class="line">                .addMember(&quot;value&quot;, &quot;$S&quot;, &quot;ResourceType&quot;)</div><div class="line">                .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 如果有父类，那么会根据不同情况调用不同的 super 语句</div><div class="line">    if (parentBinding != null) &#123;</div><div class="line">        if (parentBinding.constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(&quot;super(target, source)&quot;);</div><div class="line">        &#125; else if (constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(&quot;super(target, source.getContext())&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            constructor.addStatement(&quot;super(target, context)&quot;);</div><div class="line">        &#125;</div><div class="line">        constructor.addCode(&quot;\n&quot;);</div><div class="line">    &#125;</div><div class="line">    // 如果有绑定 Field 或者方法，那么添加 this.target = target 语句</div><div class="line">    if (hasTargetField()) &#123;</div><div class="line">        constructor.addStatement(&quot;this.target = target&quot;);</div><div class="line">        constructor.addCode(&quot;\n&quot;);</div><div class="line">    &#125;</div><div class="line">    // 如果有 View 绑定</div><div class="line">    if (hasViewBindings()) &#123;</div><div class="line">        if (hasViewLocal()) &#123;</div><div class="line">            // Local variable in which all views will be temporarily stored.</div><div class="line">            constructor.addStatement(&quot;$T view&quot;, VIEW);</div><div class="line">        &#125;</div><div class="line">        for (ViewBinding binding : viewBindings) &#123;</div><div class="line">            // 为 View 绑定生成类似于 findViewById 之类的代码</div><div class="line">            addViewBinding(constructor, binding);</div><div class="line">        &#125;</div><div class="line">        // 为 View 的集合或者数组绑定</div><div class="line">        for (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">            constructor.addStatement(&quot;$L&quot;, binding.render());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!resourceBindings.isEmpty()) &#123;</div><div class="line">            constructor.addCode(&quot;\n&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // 绑定 resource 资源的代码</div><div class="line">    if (!resourceBindings.isEmpty()) &#123;</div><div class="line">        if (constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(&quot;$T context = source.getContext()&quot;, CONTEXT);</div><div class="line">        &#125;</div><div class="line">        if (hasResourceBindingsNeedingResource(sdk)) &#123;</div><div class="line">            constructor.addStatement(&quot;$T res = context.getResources()&quot;, RESOURCES);</div><div class="line">        &#125;</div><div class="line">        for (ResourceBinding binding : resourceBindings) &#123;</div><div class="line">            constructor.addStatement(&quot;$L&quot;, binding.render(sdk));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return constructor.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的代码就生成了构造器，但是我们还是没有看到具体 <code>findViewById</code> 操作的代码。别急，这些代码都在 <code>addViewBinding(constructor, binding)</code> 里会看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">private void addViewBinding(MethodSpec.Builder result, ViewBinding binding) &#123;</div><div class="line">    if (binding.isSingleFieldBinding()) &#123;</div><div class="line">        // Optimize the common case where there&apos;s a single binding directly to a field.</div><div class="line">        FieldViewBinding fieldBinding = binding.getFieldBinding();</div><div class="line">        // 注意这里直接使用了 target. 的形式，所以属性肯定是不能 private 的</div><div class="line">        CodeBlock.Builder builder = CodeBlock.builder()</div><div class="line">                .add(&quot;target.$L = &quot;, fieldBinding.getName());</div><div class="line">        // 下面都是 View 绑定的代码</div><div class="line">        boolean requiresCast = requiresCast(fieldBinding.getType());</div><div class="line">        if (!requiresCast &amp;&amp; !fieldBinding.isRequired()) &#123;</div><div class="line">            builder.add(&quot;source.findViewById($L)&quot;, binding.getId().code);</div><div class="line">        &#125; else &#123;</div><div class="line">            builder.add(&quot;$T.find&quot;, UTILS);</div><div class="line">            builder.add(fieldBinding.isRequired() ? &quot;RequiredView&quot; : &quot;OptionalView&quot;);</div><div class="line">            if (requiresCast) &#123;</div><div class="line">                builder.add(&quot;AsType&quot;);</div><div class="line">            &#125;</div><div class="line">            builder.add(&quot;(source, $L&quot;, binding.getId().code);</div><div class="line">            if (fieldBinding.isRequired() || requiresCast) &#123;</div><div class="line">                builder.add(&quot;, $S&quot;, asHumanDescription(singletonList(fieldBinding)));</div><div class="line">            &#125;</div><div class="line">            if (requiresCast) &#123;</div><div class="line">                builder.add(&quot;, $T.class&quot;, fieldBinding.getRawType());</div><div class="line">            &#125;</div><div class="line">            builder.add(&quot;)&quot;);</div><div class="line">        &#125;</div><div class="line">        result.addStatement(&quot;$L&quot;, builder.build());</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;MemberViewBinding&gt; requiredBindings = binding.getRequiredBindings();</div><div class="line">    if (requiredBindings.isEmpty()) &#123;</div><div class="line">        result.addStatement(&quot;view = source.findViewById($L)&quot;, binding.getId().code);</div><div class="line">    &#125; else if (!binding.isBoundToRoot()) &#123;</div><div class="line">        result.addStatement(&quot;view = $T.findRequiredView(source, $L, $S)&quot;, UTILS,</div><div class="line">                binding.getId().code, asHumanDescription(requiredBindings));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    addFieldBinding(result, binding);</div><div class="line">    // OnClick 等监听事件绑定</div><div class="line">    addMethodBindings(result, binding);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，整个 <code>ButterKnifeProcessor</code> 解析注解、生成 Java 代码的流程就走完了。</p>
<p>这时我们就把整个ButterKnife的代码分析完了，来复习一下:首先我们在代码中为某个元素添加注解，然后编译，ButterKnifeProcessor会在编译前对我们添加的注解进行解析，并生成对应的java源文件。然后编译器开始编译所有的java源文件。运行的时候，我们首先执行ButterKnife.bind()方法，bind方法内部获取到对应viewbinding类的构造方法，并且借此创建出对应的对象实例，在创建的过程中也就是构造方法里，执行了注入的代码。注入完成后，我们的代码里就可以直接使用被注解修饰过的变量了。</p>
<p>ButterKnife就是这样一个优秀的基于编译期注解的注入框架，类似的框架还有Dagger2、AndroidAnnotations等。这些框架都为开发工作带来了极大的方便。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/04/21/ButterKnife-源码分析/" class="archive-article-date">
  	<time datetime="2017-04-21T07:14:38.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-04-21</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Android-NDK中armeabi和armeabi-v7，armeabi64-v8a的区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-NDK中armeabi和armeabi-v7-，armeabi64-v8a的区别"><a href="#Android-NDK中armeabi和armeabi-v7-，armeabi64-v8a的区别" class="headerlink" title="Android NDK中armeabi和armeabi v7 ，armeabi64-v8a的区别"></a>Android NDK中armeabi和armeabi v7 ，armeabi64-v8a的区别</h1><p>Android开发中如果涉及到NDK相关的开发，势必要引入.so文件。</p>
<p>ABI:指应用基于哪种指令集来进行编译，ABI以前总共有四种，分别是armeabi、armeabi-v7a、mips、x86，它们都是表示cpu的类型，现在又有了arm64-v8a。</p>
<p><em>以下讨论不包括mips和x86。</em></p>
<p>先说以前对于so的平台兼容处理方式吧。</p>
<p>armeabi就是针对普通的或旧的arm cpu，armeabi-v7a是针对有浮点运算或高级扩展功能的arm cpu。</p>
<p>armeabi-v7a可以兼容armeabi。也就是说，支持armeabi-v7a的设备同时也可以支持armeabi。但是反过来则不然。</p>
<p>以前安卓都是32位系统，运行的进程都是32位，理论上armeabi的so可以被全平台兼容，所以，理论上我们可以只提供一个armeabi的so就能在所有cpu平台运行了。也就是说如果我们引入了A和B两个库，其中A提供了全平台的armeabi、armeabi-v7a，而B只有一个armeabi的so，那么我们可以把B的这个so复制到另一个文件夹就可以被兼容了。</p>
<p>同时因为现在armeabi的设备比armeabi-v7的要少很多，所以有些应用直接提供了armeabi-v7的so。</p>
<p>现在有了arm64-v8a的CPU以及安卓64位系统，上面的方法就有点例外了。</p>
<p>arm64-v8a是可以向下兼容的，其下有armeabi-v7a，armeabi<br>armeabi-v7a向下兼容armeabi</p>
<p>兼容得不够智能：<br>对于一个cpu是arm64-v8a架构的手机，它运行app时，进入jnilibs去读取库文件时，先看有没有arm64-v8a文件夹：</p>
<blockquote>
<p>如果没有该文件夹，去找armeabi-v7a文件夹，如果没有，再去找armeabi文件夹，如果连这个文件夹也没有，就抛出异常<br>如果有arm64-v8a文件夹，那么就去找特定名称的.so文件，<strong>注意：如果没有找到，不会再往下（armeabi-v7a文件夹）找了，而是直接抛出异常</strong></p>
</blockquote>
<p>在安卓64位系统上，同时运行着32位和64位的进程（这点和Windows很像，在64位Windows上也是能同时运行32位和63位的进程的）。</p>
<p>以下讨论是基于64位安卓系统上：</p>
<ol>
<li>如果一个纯粹的java写的应用，没有使用任何的so，那么默认就应该以64位模式来运行；</li>
<li>如果一个应用中只提供了32位的so，那么这个应用会运行在32位模式，我们之前的拷贝so到其他文件夹的方式依然是可行的。</li>
<li>如果一个应用引入了两个库分别是A和B，其中A提供了armeabi，armeabi-v7，arm64-v8a，x86四个so，而B只提供了armeabi一个so，这样的话，因为应用启动时会检测到arm64-v8a的存在，所以就会以64位模式来运行了，这时需要用到的so必须为64位的，就不能使用armeabi的so来兼容了，也就是说一个进程中一旦使用了64位的so，那么就不能使用32位的so了，这点也和Windows很像。要解决这个问题，要么就是找到B的其他平台的so，要么就是去掉A的64位so，以32位模式来运行。</li>
</ol>
<p>总结:</p>
<p>1.如果为了性能考虑，最好是armabi和armabiv7的so库都引入，但是这样可能会造成apk的size比较大；</p>
<p>2.如果为了缩小apk size，可以只放armabi，但是会损害应用性能</p>
<p>3.基于国内目前64位安卓系统普及率较低，可以不考虑armeabi64-v8a</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/03/08/Android-NDK中armeabi和armeabi-v7，armeabi64-v8a的区别/" class="archive-article-date">
  	<time datetime="2017-03-08T10:29:48.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-03-08</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-android-alias" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/15/android-alias/">动态切换app图标</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有些app在遇到双11、双12之类的节日时，图标会有所变化，但其实并没有更新过版本。这是怎么做到的呢？今天提供一个解决方案：android-alias。</p>
<p><code>&lt;android-alias&gt;</code>    是manifest文件中的一个标签，顾名思义，它是某种组件的别名，这个组件就是Activity。那么动态修改图标是怎么实现的呢？</p>
<p>我们知道，manifest中有两个属性，</p>
<p><code>android.intent.action.MAIN</code>—— 决定应用程序最先启动的Activity<br><code>android.intent.category.LAUNCHER</code> —— 决定应用程序是否显示在程序列表里</p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;activity android:name=&quot;.MainActivity&quot;&gt;</div><div class="line">    &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;</div><div class="line">        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">&lt;/activity&gt;</div></pre></td></tr></table></figure>
<p>这样，应用在安装以后就会在launcher里显示图标，点击图标会首先跳转到MainActivity。</p>
<p>到了这里，alias开始发挥作用了。</p>
<p>我们在上面的组件后面再添加这样一个组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;activity-alias</div><div class="line">    android:name=&quot;.Test11&quot;</div><div class="line">    android:enabled=&quot;false&quot;</div><div class="line">    android:icon=&quot;@drawable/s11&quot;</div><div class="line">    android:label=&quot;双11&quot;</div><div class="line">    android:targetActivity=&quot;.MainActivity&quot;&gt;</div><div class="line">    &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;</div><div class="line">        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">&lt;/activity-alias&gt;</div></pre></td></tr></table></figure>
<p>这里我们为MainActivity设置了一个alias，它的名字叫Test11，然后它最重要的属性有两个，一个是icon，代表在桌面上显示的图标，一个是targetActivity，表示它实际上指向的activity，也就是点击后实际跳转的activity。</p>
<p>alias标签可以设置这些属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;activity-alias android:enabled=[&quot;true&quot; | &quot;false&quot;]</div><div class="line">                android:exported=[&quot;true&quot; | &quot;false&quot;]</div><div class="line">                android:icon=&quot;drawable resource&quot;</div><div class="line">                android:label=&quot;string resource&quot;</div><div class="line">                android:name=&quot;string&quot;</div><div class="line">                android:permission=&quot;string&quot;</div><div class="line">                android:targetActivity=&quot;string&quot; &gt;</div><div class="line">    . . .</div><div class="line">&lt;/activity-alias&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>android:enabled</strong> 属性，布尔类型，是否开启别名设置，默认值为 true；</li>
<li><strong>android:exported</strong> 属性，布尔类型，是否支持其他应用通过这个别名访问目标 Activity，默认值为 true；</li>
<li><strong>android:icon</strong> 和 <strong>label</strong> 属性：类似 <code>activity</code> 标签，表示目标 Activity 的显示图标和标签；</li>
<li><strong>android:name</strong> 属性：Activity 别名，在 <code>activity</code> 标签中， name 属性必须与对应 Activity 文件的名字保持一致，而这里的别名可任意设置，保证唯一性即可；</li>
<li><strong>android:permission</strong> 属性：权限设置，对别名的使用加以限制，详细属性值参考开发者官网对 <a href="https://developer.android.com/guide/topics/manifest/manifest-intro.html#perms" target="_blank" rel="external">权限部分</a> 的说明；</li>
<li><strong>android:targetActivity</strong> 属性：指定别名能够启动的目标 Activity，注意，属性值一定要对应到 <code>activity</code> 标签中的 name 属性，并且该 <code>activity</code> 标签一定要位于 <code>activity-alias</code> 标签前面；</li>
</ul>
<p>这样设置以后，运行应用，会发现桌面上产生了两个图标，怎么办？只要把不用的图标先禁用掉，等到服务端发来消息说要换图标的时候再动态替换就行。</p>
<p>这里要用到另外一个类：<code>PackageManager</code>,它可以管理应用里所有的组件。</p>
<p>定义两个方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">private void enableComponent(ComponentName componentName) &#123;</div><div class="line">    packageManager.setComponentEnabledSetting(componentName,</div><div class="line">            PackageManager.COMPONENT_ENABLED_STATE_ENABLED,</div><div class="line">            PackageManager.DONT_KILL_APP);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void disableComponent(ComponentName componentName) &#123;</div><div class="line">    packageManager.setComponentEnabledSetting(componentName,</div><div class="line">            PackageManager.COMPONENT_ENABLED_STATE_DISABLED,</div><div class="line">            PackageManager.DONT_KILL_APP);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据<code>PackageManager.COMPONENT_ENABLED_STATE_ENABLED</code>和<code>PackageManager.COMPONENT_ENABLED_STATE_DISABLED</code>以及componentName，就可以控制某个组件是否可用了。</p>
<p>已经很明了了，我们现在可以根据服务器的指令动态修改app的icon。流程如下：</p>
<ol>
<li>应用里设置不同图标对应的alias</li>
<li>禁用除默认图标以外的其他alias</li>
<li>在程序中设置接受指令的操作，通过PackageManager管理Component，动态切换图标。</li>
</ol>
<p>简单的代码实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line">    private ComponentName default;</div><div class="line">    private ComponentName double11;</div><div class="line">    private ComponentName double12;</div><div class="line">    private PackageManager packageManager;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        default = getComponentName();</div><div class="line">        double11 = new ComponentName(getBaseContext(),&quot;com.example.changeicon.Test11&quot;);</div><div class="line">        double12 = new ComponentName(getBaseContext(),&quot;com.example.changeicon.Test12&quot;);</div><div class="line">        packageManager = getApplicationContext().getPackageManager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void changeIcon11(View view) &#123;</div><div class="line">        disableComponent(mDefault);</div><div class="line">        disableComponent(mDouble12);</div><div class="line">        enableComponent(mDouble11);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void changeIcon12(View view) &#123;</div><div class="line">        disableComponent(mDefault);</div><div class="line">        disableComponent(mDouble11);</div><div class="line">        enableComponent(mDouble12);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void enableComponent(ComponentName componentName) &#123;    	      								packageManager.setComponentEnabledSetting(componentName,</div><div class="line">    		PackageManager.COMPONENT_ENABLED_STATE_ENABLED,</div><div class="line">    		PackageManager.DONT_KILL_APP);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void disableComponent(ComponentName componentName) &#123;</div><div class="line">        packageManager.setComponentEnabledSetting(componentName,</div><div class="line">                PackageManager.COMPONENT_ENABLED_STATE_DISABLED,</div><div class="line">                PackageManager.DONT_KILL_APP);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>修改之后，需要稍等片刻才能看到变化。如果想在修改完成之后立即看到变化，只能通过 Intent 重启 Launcher 应用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Intent intent = new Intent(Intent.ACTION_MAIN);</div><div class="line">intent.addCategory(Intent.CATEGORY_HOME);</div><div class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</div><div class="line">List&lt;ResolveInfo&gt; resolves = pm.queryIntentActivities(intent, 0);</div><div class="line">for (ResolveInfo res : resolves) &#123;</div><div class="line">    if (res.activityInfo != null) &#123;</div><div class="line">        ActivityManager am = (ActivityManager) getSystemService(ACTIVITY_SERVICE);</div><div class="line">        am.killBackgroundProcesses(res.activityInfo.packageName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/01/15/android-alias/" class="archive-article-date">
  	<time datetime="2017-01-15T14:24:14.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-01-15</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="run-在树莓派3上运行AndroidThings" class="article article-type-run" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/31/在树莓派3上运行AndroidThings/">在树莓派3上运行AndroidThings</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>AndroidThings是Google最近推出的一款物联网操作系统。它的前身是Brillo。在Brillo的基础上，增加了Android Studio、Android SDK、Google Play 服务、Google 云平台的支持，使得普通的App开发者不需要嵌入式开发的基础，就可以像开发普通应用程序一样开发一个智能设备。</p>
<p>随着AndroidThings的发布，google同时宣布了三款AndroidThings支持的开发板。开发者可以在这些开发板上快速进行产品原型设计和开发，而不需要过多关注内核、固件和开发板本身，从而能更专注地编写Android Things应用程序。</p>
<p>这三款开发板分别是：</p>
<ul>
<li><p><a href="https://software.intel.com/en-us/iot/android-things" target="_blank" rel="external">Intel® Edison</a></p>
</li>
<li><p><a href="http://www.nxp.com/AndroidThingsGS" target="_blank" rel="external">NXP Pico i.MX6UL</a></p>
</li>
<li><p><a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/" target="_blank" rel="external">Raspberry Pi 3</a></p>
</li>
</ul>
<p>以上三款中我选择了树莓派做试验，原因是树莓派在国内的硬件爱好者中已经相当流行，并且有很多相关的论坛可以去参与讨论。最重要的是树莓派相对于其他两款来说最便宜，且在几大电商网站都可以方便的买到。</p>
<p>树莓派3相比上一代性能增强很多，采用64位四核1.2GHz处理器，搭载1GB LPDDR2内存，虽然配置仅相当于入门级Android手机，但运行Android系统还是无压力的，唯一的缺点是没有硬件加速是硬伤。</p>
<p>需要准备的东西：</p>
<ol>
<li><p>树莓派3开发板</p>
</li>
<li><p>一张不小于8G的sd卡</p>
</li>
<li><p>一根usb线</p>
</li>
<li><p>一根hdmi转接线和一个外接显示器</p>
</li>
<li><p>一根网线</p>
<p>​</p>
</li>
</ol>
<p>首先先下载树莓派版的 <a href="https://dl.google.com/dl/androidthings/rpi3/devpreview/1/androidthings_rpi3_devpreview_1.zip" target="_blank" rel="external">AndroidThings image 开发者预览版</a>。</p>
<p>之后需要把系统镜像烧录到sd卡上，要注意的是sd卡必须先格式化为FAT32。</p>
<p>这里以macbook Pro为例，官方有<a href="https://www.raspberrypi.org/documentation/installation/installing-images/linux.md" target="_blank" rel="external">Linux</a>和<a href="https://www.raspberrypi.org/documentation/installation/installing-images/windows.md" target="_blank" rel="external">Windows</a>的教程。</p>
<ol>
<li><p>把sd卡插入到电脑，执行<code>diskutil list</code>查看mac上挂在的存储设备。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/dev/disk0 (internal, physical):</div><div class="line">   #:                       TYPE NAME                    SIZE       IDENTIFIER</div><div class="line">   0:      GUID_partition_scheme                        *251.0 GB   disk0</div><div class="line">   1:                        EFI EFI                     209.7 MB   disk0s1</div><div class="line">   2:          Apple_CoreStorage Macintosh HD            250.1 GB   disk0s2</div><div class="line">   3:                 Apple_Boot Recovery HD             650.0 MB   disk0s3</div><div class="line"></div><div class="line">/dev/disk1 (internal, virtual):</div><div class="line">   #:                       TYPE NAME                    SIZE       IDENTIFIER</div><div class="line">   0:                            Macintosh HD           +249.8 GB   disk1</div><div class="line">                                 Logical Volume on disk0s2</div><div class="line">                                 63A098E0-E7F3-4055-8F92-E8A9F37B78EB</div><div class="line">                                 Unlocked Encrypted</div><div class="line"></div><div class="line">/dev/disk2 (external, physical):</div><div class="line">   #:                       TYPE NAME                    SIZE       IDENTIFIER</div><div class="line">   0:      GUID_partition_scheme                        *15.5 GB    disk2</div><div class="line">   1: 314F99D5-B2BF-4883-8D03-E2F2CE507D6A               67.1 MB    disk2s1</div></pre></td></tr></table></figure>
<p>在这里/dev/disk2就是我自己的sd卡，但是在你的电脑上可能是/dev/diskn。</p>
</li>
<li><p>如果sd卡已经被自动安装，那么需要执行unmount命令来卸载它。详细命令是<code>diskutil unmountdisk /dev/disk2</code>。</p>
</li>
<li><p>执行烧录程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dd if=&lt;your_image_path&gt; of=/dev/disk2 bs=2m</div></pre></td></tr></table></figure>
<p>如果提示没有权限，加上sudo就可以了。</p>
<p>敲回车开始执行，但是这时候没有任何的进度提示，你耐心等待就好了，大概需要七八分钟的样子，烧录完成后，会提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">925+0 records in</div><div class="line">925+0 records out</div><div class="line">1939865600 bytes transferred in 576.382578 secs (3365587 bytes/sec)</div></pre></td></tr></table></figure>
<p>这样就完成烧录了。</p>
</li>
<li><p>为树莓派插上usb线供电，把sd卡插入到树莓派的卡槽中，用hdmi线连接板子和显示器，树莓派会自动开机，并且运行AndroidThings系统。</p>
</li>
<li><p>连接网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">adb shell am startservice \</div><div class="line">   -n com.google.wifisetup/.WifiSetupService \</div><div class="line">   -a WifiSetupService.Connect \</div><div class="line">   -e ssid &lt;Network_SSID&gt; \</div><div class="line">   -e passphrase &lt;Network_Passcode&gt;</div></pre></td></tr></table></figure>
<p>验证连接成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ adb logcat -d | grep Wifi</div><div class="line">...</div><div class="line">V WifiWatcher: Network state changed to CONNECTED</div><div class="line">V WifiWatcher: SSID changed: ...</div><div class="line">I WifiConfigurator: Successfully connected to ...</div></pre></td></tr></table></figure>
<p>测试连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ adb shell ping 8.8.8.8</div><div class="line">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</div><div class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=57 time=6.67 ms</div><div class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=57 time=55.5 ms</div><div class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=57 time=23.0 ms</div><div class="line">64 bytes from 8.8.8.8: icmp_seq=4 ttl=57 time=245 ms</div></pre></td></tr></table></figure>
</li>
</ol>
<p>没错，你可以像操作一台普通的手机一样通过adb命令来操作树莓派，比如通过Android Studio run一个android程序到树莓派上。</p>
<p>这里有官方的<a href="https://developer.android.google.cn/things/sdk/samples.html" target="_blank" rel="external">示例代码</a>和github上的一些<a href="https://github.com/androidthings" target="_blank" rel="external">开源项目</a>。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/31/在树莓派3上运行AndroidThings/" class="archive-article-date">
  	<time datetime="2016-12-31T05:43:10.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-31</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-使用aapt查看apk应用信息" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/31/使用aapt查看apk应用信息/">使用aapt查看apk应用信息</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果从一个Android应用的APK文件中获取minSDKVersion，targetSdkVersion，permissions,configurations等应用信息，很多人的第一反应是把.apk文件重命名为.zip，然后解压，找到AndroidManifest.xml文件，然后从里面找对应信息。但是事与愿违，当你打开这个文件时，内容是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">0300 0800 b8f4 0000 0100 1c00 f87e 0000</div><div class="line">4a01 0000 0000 0000 0000 0000 4405 0000</div><div class="line">0000 0000 0000 0000 1a00 0000 3400 0000</div><div class="line">5200 0000 7600 0000 8200 0000 a400 0000</div><div class="line">b800 0000 d600 0000 f000 0000 fc00 0000</div><div class="line">0a01 0000 2001 0000 3a01 0000 4801 0000</div><div class="line">6001 0000 7801 0000 8601 0000 9a01 0000</div><div class="line">b801 0000 de01 0000 ee01 0000 1802 0000</div><div class="line">3002 0000 4a02 0000 7402 0000 8602 0000</div><div class="line">9802 0000 ac02 0000 c402 0000 e002 0000</div><div class="line">f202 0000 4a03 0000 4e03 0000 6003 0000</div><div class="line">9403 0000 c803 0000 dc03 0000 1204 0000</div><div class="line">2e04 0000 3604 0000 4004 0000 5404 0000</div><div class="line">6c04 0000 d604 0000 f804 0000 4e05 0000</div><div class="line">a005 0000 dc05 0000 1806 0000 6206 0000</div><div class="line">c606 0000 2e07 0000 6407 0000 a207 0000</div><div class="line">e407 0000 0008 0000 3208 0000 7808 0000</div><div class="line">b208 0000 0409 0000 4e09 0000 aa09 0000</div><div class="line">000a 0000 380a 0000 840a 0000 c20a 0000</div><div class="line">fa0a 0000 3c0b 0000 680b 0000 ac0b 0000</div><div class="line">f60b 0000 420c 0000 940c 0000 ea0c 0000</div><div class="line">4e0d 0000 a60d 0000 ec0d 0000 280e 0000</div><div class="line">860e 0000 da0e 0000 240f 0000 760f 0000</div><div class="line">d20f 0000 0e10 0000 5210 0000 a210 0000</div><div class="line">bc10 0000 2811 0000 3e11 0000 6211 0000</div><div class="line">9611 0000 aa11 0000 0a12 0000 2812 0000</div><div class="line">3812 0000 7a12 0000 8e12 0000 d012 0000</div><div class="line">e212 0000 4013 0000 8e13 0000 b013 0000</div><div class="line">d413 0000 f413 0000 1614 0000 ac14 0000</div><div class="line">e414 0000 2815 0000 6c15 0000 ba15 0000</div><div class="line">c615 0000 f015 0000 2816 0000 6e16 0000</div><div class="line">0c17 0000 8c17 0000 0a18 0000 8818 0000</div></pre></td></tr></table></figure>
<p>这个披着xml外衣的文件已经不再是人类可读的格式。</p>
<p>其实在Android SDK目录下，已经有这样一个工具可以做到以上的需求，那就是aapt。</p>
<p>aapt（Android Asset Packaging Tool）可以用来列举、添加、移除APK包里的文件，打包资源或者压缩PNG文件等。这个工具安装在<code>&lt;path_to_android_sdk&gt;/build-tools/&lt;build_tool_version_such_as_24.0.2&gt;/aapt</code></p>
<p>目录下。首先看下它有哪些命令：</p>
<ul>
<li><p><code>aapt list</code> - 列举 ZIP, JAR 或者 APK 文件里的内容。</p>
</li>
<li><p><code>aapt dump</code> - 从 APK 文件里导出指定的信息。</p>
</li>
<li><p><code>aapt package</code> - 打包 Android 资源。</p>
</li>
<li><p><code>aapt remove</code> - 删除 ZIP、JAR 或者 APK 文件里的内容。</p>
</li>
<li><p><code>aapt add</code> - 把文件添加到 ZIP、JAR 或者 APK 文件里。</p>
</li>
<li><p><code>aapt crunch</code> - 压缩 PNG 文件。</p>
<p>对病历夹app的apk文件执行dump命令：<code>aapt dump badging app-debug.apk</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line">package: name=&apos;com.apricotforest.dossier&apos; versionCode=&apos;97&apos; versionName=&apos;4.36.0-debug&apos;</div><div class="line">sdkVersion:&apos;16&apos;</div><div class="line">targetSdkVersion:&apos;21&apos;</div><div class="line">uses-permission:&apos;com.apricotforest.dossier.permission.MIPUSH_RECEIVE&apos;</div><div class="line">uses-permission:&apos;android.permission.ACCESS_COARSE_LOCATION&apos;</div><div class="line">uses-permission:&apos;android.permission.ACCESS_FINE_LOCATION&apos;</div><div class="line">uses-permission:&apos;android.permission.READ_LOGS&apos;</div><div class="line">uses-permission:&apos;android.permission.GET_TASKS&apos;</div><div class="line">uses-permission:&apos;android.permission.DISABLE_KEYGUARD&apos;</div><div class="line">uses-permission:&apos;com.android.launcher.permission.INSTALL_SHORTCUT&apos;</div><div class="line">uses-permission:&apos;com.android.launcher.permission.UNINSTALL_SHORTCUT&apos;</div><div class="line">uses-permission:&apos;android.permission.CAMERA&apos;</div><div class="line">uses-permission:&apos;android.permission.FLASHLIGHT&apos;</div><div class="line">uses-permission:&apos;android.permission.RECORD_AUDIO&apos;</div><div class="line">uses-feature:&apos;android.hardware.camera&apos;</div><div class="line">uses-feature:&apos;android.hardware.camera.autofocus&apos;</div><div class="line">uses-permission:&apos;android.permission.INTERNET&apos;</div><div class="line">uses-permission:&apos;android.permission.ACCESS_NETWORK_STATE&apos;</div><div class="line">uses-permission:&apos;android.permission.READ_PHONE_STATE&apos;</div><div class="line">uses-permission:&apos;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&apos;</div><div class="line">uses-permission:&apos;android.permission.WRITE_EXTERNAL_STORAGE&apos;</div><div class="line">uses-permission:&apos;android.permission.VIBRATE&apos;</div><div class="line">uses-permission:&apos;android.permission.ACCESS_WIFI_STATE&apos;</div><div class="line">uses-permission:&apos;android.permission.CALL_PHONE&apos;</div><div class="line">uses-feature-not-required:&apos;android.hardware.telephony&apos;</div><div class="line">uses-feature-not-required:&apos;android.hardware.telephony.cdma&apos;</div><div class="line">uses-feature-not-required:&apos;android.hardware.gsm&apos;</div><div class="line">uses-permission:&apos;android.permission.READ_CONTACTS&apos;</div><div class="line">uses-permission:&apos;android.permission.RESTART_PACKAGES&apos;</div><div class="line">uses-permission:&apos;android.permission.CHANGE_WIFI_STATE&apos;</div><div class="line">uses-permission:&apos;android.permission.CHANGE_CONFIGURATION&apos;</div><div class="line">uses-permission:&apos;android.permission.RECEIVE_BOOT_COMPLETED&apos;</div><div class="line">uses-permission:&apos;android.permission.DOWNLOAD_WITHOUT_NOTIFICATION&apos;</div><div class="line">uses-permission:&apos;android.permission.ACCESS_DOWNLOAD_MANAGER&apos;</div><div class="line">uses-permission:&apos;android.permission.WRITE_SETTINGS&apos;</div><div class="line">uses-permission:&apos;android.permission.WAKE_LOCK&apos;</div><div class="line">uses-permission:&apos;com.android.launcher.permission.READ_SETTINGS&apos;</div><div class="line">uses-permission:&apos;android.permission.READ_EXTERNAL_STORAGE&apos;</div><div class="line">uses-permission:&apos;android.permission.BROADCAST_STICKY&apos;</div><div class="line">uses-permission:&apos;android.permission.RECEIVE_USER_PRESENT&apos;</div><div class="line">uses-permission:&apos;android.permission.KILL_BACKGROUND_PROCESSES&apos;</div><div class="line">uses-permission:&apos;android.permission.BLUETOOTH&apos;</div><div class="line">uses-permission:&apos;android.permission.BATTERY_STATS&apos;</div><div class="line">uses-permission:&apos;android.permission.SYSTEM_ALERT_WINDOW&apos;</div><div class="line">application-label:&apos;病历夹&apos;</div><div class="line">application-label-ca:&apos;病历夹&apos;</div><div class="line">application-label-da:&apos;病历夹&apos;</div><div class="line">application-label-fa:&apos;病历夹&apos;</div><div class="line">application-label-ja:&apos;病历夹&apos;</div><div class="line">application-label-nb:&apos;病历夹&apos;</div><div class="line">application-label-de:&apos;病历夹&apos;</div><div class="line">application-label-af:&apos;病历夹&apos;</div><div class="line">application-label-bg:&apos;病历夹&apos;</div><div class="line">application-label-th:&apos;病历夹&apos;</div><div class="line">application-label-fi:&apos;病历夹&apos;</div><div class="line">application-label-hi:&apos;病历夹&apos;</div><div class="line">application-label-vi:&apos;病历夹&apos;</div><div class="line">application-label-sk:&apos;病历夹&apos;</div><div class="line">application-label-uk:&apos;病历夹&apos;</div><div class="line">application-label-el:&apos;病历夹&apos;</div><div class="line">application-label-nl:&apos;病历夹&apos;</div><div class="line">application-label-pl:&apos;病历夹&apos;</div><div class="line">application-label-sl:&apos;病历夹&apos;</div><div class="line">application-label-tl:&apos;病历夹&apos;</div><div class="line">application-label-am:&apos;病历夹&apos;</div><div class="line">application-label-in:&apos;病历夹&apos;</div><div class="line">application-label-ko:&apos;病历夹&apos;</div><div class="line">application-label-ro:&apos;病历夹&apos;</div><div class="line">application-label-ar:&apos;病历夹&apos;</div><div class="line">application-label-fr:&apos;病历夹&apos;</div><div class="line">application-label-hr:&apos;病历夹&apos;</div><div class="line">application-label-sr:&apos;病历夹&apos;</div><div class="line">application-label-tr:&apos;病历夹&apos;</div><div class="line">application-label-cs:&apos;病历夹&apos;</div><div class="line">application-label-es:&apos;病历夹&apos;</div><div class="line">application-label-it:&apos;病历夹&apos;</div><div class="line">application-label-lt:&apos;病历夹&apos;</div><div class="line">application-label-pt:&apos;病历夹&apos;</div><div class="line">application-label-hu:&apos;病历夹&apos;</div><div class="line">application-label-ru:&apos;病历夹&apos;</div><div class="line">application-label-zu:&apos;病历夹&apos;</div><div class="line">application-label-lv:&apos;病历夹&apos;</div><div class="line">application-label-sv:&apos;病历夹&apos;</div><div class="line">application-label-iw:&apos;病历夹&apos;</div><div class="line">application-label-sw:&apos;病历夹&apos;</div><div class="line">application-label-bs_BA:&apos;病历夹&apos;</div><div class="line">application-label-fr_CA:&apos;病历夹&apos;</div><div class="line">application-label-lo_LA:&apos;病历夹&apos;</div><div class="line">application-label-en_GB:&apos;病历夹&apos;</div><div class="line">application-label-bn_BD:&apos;病历夹&apos;</div><div class="line">application-label-et_EE:&apos;病历夹&apos;</div><div class="line">application-label-ka_GE:&apos;病历夹&apos;</div><div class="line">application-label-ky_KG:&apos;病历夹&apos;</div><div class="line">application-label-km_KH:&apos;病历夹&apos;</div><div class="line">application-label-zh_HK:&apos;病历夹&apos;</div><div class="line">application-label-si_LK:&apos;病历夹&apos;</div><div class="line">application-label-mk_MK:&apos;病历夹&apos;</div><div class="line">application-label-ur_PK:&apos;病历夹&apos;</div><div class="line">application-label-sq_AL:&apos;病历夹&apos;</div><div class="line">application-label-hy_AM:&apos;病历夹&apos;</div><div class="line">application-label-my_MM:&apos;病历夹&apos;</div><div class="line">application-label-zh_CN:&apos;病历夹&apos;</div><div class="line">application-label-pa_IN:&apos;病历夹&apos;</div><div class="line">application-label-ta_IN:&apos;病历夹&apos;</div><div class="line">application-label-te_IN:&apos;病历夹&apos;</div><div class="line">application-label-ml_IN:&apos;病历夹&apos;</div><div class="line">application-label-en_IN:&apos;病历夹&apos;</div><div class="line">application-label-kn_IN:&apos;病历夹&apos;</div><div class="line">application-label-mr_IN:&apos;病历夹&apos;</div><div class="line">application-label-gu_IN:&apos;病历夹&apos;</div><div class="line">application-label-mn_MN:&apos;病历夹&apos;</div><div class="line">application-label-ne_NP:&apos;病历夹&apos;</div><div class="line">application-label-pt_BR:&apos;病历夹&apos;</div><div class="line">application-label-gl_ES:&apos;病历夹&apos;</div><div class="line">application-label-eu_ES:&apos;病历夹&apos;</div><div class="line">application-label-is_IS:&apos;病历夹&apos;</div><div class="line">application-label-es_US:&apos;病历夹&apos;</div><div class="line">application-label-pt_PT:&apos;病历夹&apos;</div><div class="line">application-label-en_AU:&apos;病历夹&apos;</div><div class="line">application-label-zh_TW:&apos;病历夹&apos;</div><div class="line">application-label-be_BY:&apos;病历夹&apos;</div><div class="line">application-label-ms_MY:&apos;病历夹&apos;</div><div class="line">application-label-az_AZ:&apos;病历夹&apos;</div><div class="line">application-label-kk_KZ:&apos;病历夹&apos;</div><div class="line">application-label-uz_UZ:&apos;病历夹&apos;</div><div class="line">application-icon-120:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-160:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-240:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-320:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-480:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-65534:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-icon-65535:&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application: label=&apos;病历夹&apos; icon=&apos;res/drawable-xxhdpi-v4/icon.png&apos;</div><div class="line">application-debuggable</div><div class="line">launchable-activity: name=&apos;com.apricotforest.dossier.medicalrecord.activity.main.MainLoadingActivity&apos;  label=&apos;病历夹&apos; icon=&apos;&apos;</div><div class="line">launchable-activity: name=&apos;com.squareup.leakcanary.internal.DisplayLeakActivity&apos;  label=&apos;Leaks&apos; icon=&apos;res/drawable-xxhdpi-v4/leak_canary_icon.png&apos;</div><div class="line">uses-feature:&apos;android.hardware.location&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.location&apos;,&apos;requested a location access permission&apos;</div><div class="line">uses-feature:&apos;android.hardware.location.gps&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.location.gps&apos;,&apos;requested android.permission.ACCESS_FINE_LOCATION permission&apos;</div><div class="line">uses-feature:&apos;android.hardware.location.network&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.location.network&apos;,&apos;requested android.permission.ACCESS_COURSE_LOCATION permission&apos;</div><div class="line">uses-feature:&apos;android.hardware.bluetooth&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.bluetooth&apos;,&apos;requested android.permission.BLUETOOTH or android.permission.BLUETOOTH_ADMIN permission and targetSdkVersion &gt; 4&apos;</div><div class="line">uses-feature:&apos;android.hardware.microphone&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.microphone&apos;,&apos;requested android.permission.RECORD_AUDIO permission&apos;</div><div class="line">uses-feature:&apos;android.hardware.wifi&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.wifi&apos;,&apos;requested android.permission.ACCESS_WIFI_STATE, android.permission.CHANGE_WIFI_STATE, or android.permission.CHANGE_WIFI_MULTICAST_STATE permission&apos;</div><div class="line">uses-feature:&apos;android.hardware.touchscreen&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.touchscreen&apos;,&apos;assumed you require a touch screen unless explicitly made optional&apos;</div><div class="line">uses-feature:&apos;android.hardware.screen.portrait&apos;</div><div class="line">uses-implied-feature:&apos;android.hardware.screen.portrait&apos;,&apos;one or more activities have specified a portrait orientation&apos;</div><div class="line">main</div><div class="line">other-activities</div><div class="line">other-receivers</div><div class="line">other-services</div><div class="line">supports-screens: &apos;small&apos; &apos;normal&apos; &apos;large&apos; &apos;xlarge&apos;</div><div class="line">supports-any-density: &apos;true&apos;</div><div class="line">locales: &apos;--_--&apos; &apos;ca&apos; &apos;da&apos; &apos;fa&apos; &apos;ja&apos; &apos;nb&apos; &apos;de&apos; &apos;af&apos; &apos;bg&apos; &apos;th&apos; &apos;fi&apos; &apos;hi&apos; &apos;vi&apos; &apos;sk&apos; &apos;uk&apos; &apos;el&apos; &apos;nl&apos; &apos;pl&apos; &apos;sl&apos; &apos;tl&apos; &apos;am&apos; &apos;in&apos; &apos;ko&apos; &apos;ro&apos; &apos;ar&apos; &apos;fr&apos; &apos;hr&apos; &apos;sr&apos; &apos;tr&apos; &apos;cs&apos; &apos;es&apos; &apos;it&apos; &apos;lt&apos; &apos;pt&apos; &apos;hu&apos; &apos;ru&apos; &apos;zu&apos; &apos;lv&apos; &apos;sv&apos; &apos;iw&apos; &apos;sw&apos; &apos;bs_BA&apos; &apos;fr_CA&apos; &apos;lo_LA&apos; &apos;en_GB&apos; &apos;bn_BD&apos; &apos;et_EE&apos; &apos;ka_GE&apos; &apos;ky_KG&apos; &apos;km_KH&apos; &apos;zh_HK&apos; &apos;si_LK&apos; &apos;mk_MK&apos; &apos;ur_PK&apos; &apos;sq_AL&apos; &apos;hy_AM&apos; &apos;my_MM&apos; &apos;zh_CN&apos; &apos;pa_IN&apos; &apos;ta_IN&apos; &apos;te_IN&apos; &apos;ml_IN&apos; &apos;en_IN&apos; &apos;kn_IN&apos; &apos;mr_IN&apos; &apos;gu_IN&apos; &apos;mn_MN&apos; &apos;ne_NP&apos; &apos;pt_BR&apos; &apos;gl_ES&apos; &apos;eu_ES&apos; &apos;is_IS&apos; &apos;es_US&apos; &apos;pt_PT&apos; &apos;en_AU&apos; &apos;zh_TW&apos; &apos;be_BY&apos; &apos;ms_MY&apos; &apos;az_AZ&apos; &apos;kk_KZ&apos; &apos;uz_UZ&apos;</div><div class="line">densities: &apos;120&apos; &apos;160&apos; &apos;240&apos; &apos;320&apos; &apos;480&apos; &apos;65534&apos; &apos;65535&apos;</div><div class="line">native-code: &apos;armeabi&apos; &apos;armeabi-v7a&apos;</div></pre></td></tr></table></figure>
<p>获取应用权限说明：<code>aapt dump permissions app-debug.apk</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">package: com.apricotforest.dossier</div><div class="line">permission: com.apricotforest.dossier.permission.MIPUSH_RECEIVE</div><div class="line">uses-permission: com.apricotforest.dossier.permission.MIPUSH_RECEIVE</div><div class="line">uses-permission: android.permission.ACCESS_COARSE_LOCATION</div><div class="line">uses-permission: android.permission.ACCESS_FINE_LOCATION</div><div class="line">uses-permission: android.permission.READ_LOGS</div><div class="line">uses-permission: android.permission.GET_TASKS</div><div class="line">uses-permission: android.permission.DISABLE_KEYGUARD</div><div class="line">uses-permission: com.android.launcher.permission.INSTALL_SHORTCUT</div><div class="line">uses-permission: com.android.launcher.permission.UNINSTALL_SHORTCUT</div><div class="line">uses-permission: android.permission.CAMERA</div><div class="line">uses-permission: android.permission.FLASHLIGHT</div><div class="line">uses-permission: android.permission.RECORD_AUDIO</div><div class="line">uses-permission: android.permission.INTERNET</div><div class="line">uses-permission: android.permission.ACCESS_NETWORK_STATE</div><div class="line">uses-permission: android.permission.READ_PHONE_STATE</div><div class="line">uses-permission: android.permission.MOUNT_UNMOUNT_FILESYSTEMS</div><div class="line">uses-permission: android.permission.WRITE_EXTERNAL_STORAGE</div><div class="line">uses-permission: android.permission.VIBRATE</div><div class="line">uses-permission: android.permission.ACCESS_WIFI_STATE</div><div class="line">uses-permission: android.permission.CALL_PHONE</div><div class="line">uses-permission: android.permission.READ_CONTACTS</div><div class="line">uses-permission: android.permission.RESTART_PACKAGES</div><div class="line">uses-permission: android.permission.CHANGE_WIFI_STATE</div><div class="line">uses-permission: android.permission.CHANGE_CONFIGURATION</div><div class="line">uses-permission: android.permission.RECEIVE_BOOT_COMPLETED</div><div class="line">uses-permission: android.permission.DOWNLOAD_WITHOUT_NOTIFICATION</div><div class="line">uses-permission: android.permission.ACCESS_DOWNLOAD_MANAGER</div><div class="line">uses-permission: android.permission.WRITE_SETTINGS</div><div class="line">uses-permission: android.permission.WAKE_LOCK</div><div class="line">uses-permission: com.android.launcher.permission.READ_SETTINGS</div><div class="line">uses-permission: android.permission.READ_EXTERNAL_STORAGE</div><div class="line">uses-permission: android.permission.BROADCAST_STICKY</div><div class="line">uses-permission: android.permission.RECEIVE_USER_PRESENT</div><div class="line">uses-permission: android.permission.KILL_BACKGROUND_PROCESSES</div><div class="line">uses-permission: android.permission.BLUETOOTH</div><div class="line">uses-permission: android.permission.BATTERY_STATS</div><div class="line">uses-permission: android.permission.SYSTEM_ALERT_WINDOW</div></pre></td></tr></table></figure>
<p>获取apk的配置列表：<code>aapt dump configurations app-debug.apk</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line">65534dpi-v21</div><div class="line">nodpi-v4</div><div class="line">v21</div><div class="line">v23</div><div class="line">ldpi-v4</div><div class="line">mdpi-v4</div><div class="line">hdpi-v4</div><div class="line">xhdpi-v4</div><div class="line">xxhdpi-v4</div><div class="line">xxhdpi-v11</div><div class="line">ldrtl-xxhdpi-v17</div><div class="line">sw600dp-v13</div><div class="line">v14</div><div class="line">v17</div><div class="line">ldrtl-v17</div><div class="line">800x480</div><div class="line">800x480-v17</div><div class="line">ca</div><div class="line">da</div><div class="line">fa</div><div class="line">ja</div><div class="line">nb</div><div class="line">de</div><div class="line">af</div><div class="line">bg</div><div class="line">th</div><div class="line">fi</div><div class="line">hi</div><div class="line">vi</div><div class="line">sk</div><div class="line">uk</div><div class="line">el</div><div class="line">nl</div><div class="line">pl</div><div class="line">sl</div><div class="line">tl</div><div class="line">am</div><div class="line">in</div><div class="line">ko</div><div class="line">ro</div><div class="line">ar</div><div class="line">fr</div><div class="line">hr</div><div class="line">sr</div><div class="line">tr</div><div class="line">cs</div><div class="line">es</div><div class="line">it</div><div class="line">lt</div><div class="line">pt</div><div class="line">hu</div><div class="line">ru</div><div class="line">zu</div><div class="line">lv</div><div class="line">sv</div><div class="line">iw</div><div class="line">sw</div><div class="line">bs-BA</div><div class="line">fr-CA</div><div class="line">lo-LA</div><div class="line">en-GB</div><div class="line">bn-BD</div><div class="line">et-EE</div><div class="line">ka-GE</div><div class="line">ky-KG</div><div class="line">km-KH</div><div class="line">zh-HK</div><div class="line">si-LK</div><div class="line">mk-MK</div><div class="line">ur-PK</div><div class="line">sq-AL</div><div class="line">hy-AM</div><div class="line">my-MM</div><div class="line">zh-CN</div><div class="line">pa-IN</div><div class="line">ta-IN</div><div class="line">te-IN</div><div class="line">ml-IN</div><div class="line">en-IN</div><div class="line">kn-IN</div><div class="line">mr-IN</div><div class="line">gu-IN</div><div class="line">mn-MN</div><div class="line">ne-NP</div><div class="line">pt-BR</div><div class="line">gl-ES</div><div class="line">eu-ES</div><div class="line">is-IS</div><div class="line">es-US</div><div class="line">pt-PT</div><div class="line">en-AU</div><div class="line">zh-TW</div><div class="line">be-BY</div><div class="line">ms-MY</div><div class="line">az-AZ</div><div class="line">kk-KZ</div><div class="line">uz-UZ</div><div class="line">large-v4</div><div class="line">xlarge-v4</div><div class="line">w820dp-v13</div><div class="line">h720dp-v13</div><div class="line">v18</div><div class="line">land</div><div class="line">night-v8</div><div class="line">v11</div><div class="line">v12</div><div class="line">v19</div><div class="line">ldltr-v21</div><div class="line">v22</div><div class="line">v13</div><div class="line">sw720dp-v13</div><div class="line">port</div></pre></td></tr></table></figure>
<p>是不是一目了然，很多时候只需要执行一个命令就能得到想要的东西了，省去了解压或者反编译的繁琐。</p>
<p>当然，aapt工具能做的还有很多：</p>
<!--#打印出apk里的资源清单-->
<p><code>aapt dump resources app-debug.apk</code></p>
<!--列出zip文件里的文件-->
<p><code>aapt dump list -v -a  app-debug.apk</code></p>
<p>不一一列举了。</p>
<p>enjoy it.</p>
</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/31/使用aapt查看apk应用信息/" class="archive-article-date">
  	<time datetime="2016-12-31T05:13:46.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-31</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-WebView的内存泄露" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/12/WebView的内存泄露/">WebView的内存泄露</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>移动应用除了实现产品本身的功能以外，也是很多活动推广、运营需求以及展示广告的落点，这就需要一个实时性强，并且调整灵活的展现形式。无疑，html页面是最合适的选择（在React Native还没有大面积使用的情况下）。所以，移动端的webview几乎在每个应用中都会出现。但是在Android上使用webview的时候，如果不注意的话，还是有一些问题的。</p>
<p>病历夹目前在很多地方用到了webview，比如banner内容的展示、表单、诊疗圈、意见反馈等等。然而使用Debug版本带着Leak Canary运行的时候，每当关闭一个webview，几乎都会报一个内存泄露的问题。搜索了一下Android webview相关的内存泄露问题，总结了几种主流的解决方案。</p>
<h2 id="一、-动态生成webview"><a href="#一、-动态生成webview" class="headerlink" title="一、 动态生成webview"></a>一、 动态生成webview</h2><p>要使用webview不造成内存泄露，首先应该做的就是不能在xml文件中定义webview节点，而是在需要的时候动态生成。即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">WebView webView = new WebView(getApplicationContext());</div><div class="line">LinearLayout parent = findViewById(R.id.parent);</div><div class="line">parent.addView(webView);</div></pre></td></tr></table></figure>
<p>然后一定要在Activity的onDestroy()中调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if(webView != null) &#123;</div><div class="line">	((ViewGroup)webView.getParent()).removeView(webView);</div><div class="line">	webView.destroy();</div><div class="line">	webView = null;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要注意的是，new WebView(Context context)时必须要传入ApplicationContext，如果传入Activity的Context的引用，那么对内存的引用会一直被保持。有人用次方法解决了Activity被销毁后依然不能释放Activity的问题，但是如果需要在webview中打开连接或者打开的页面中带有flash，或者webview想弹出一个dialog，都会导致从ApplicationContext到Activity Context的强制类型转换错误，从而导致应用崩溃。这是因为在以上提到的操作中，系统会把webview当做父控件，然后在该空间上绘制内容，它想找一个Activity的context来绘制，但是传入的却不是Activity的context，导致出错。</p>
<h2 id="二、使用反射清空引用"><a href="#二、使用反射清空引用" class="headerlink" title="二、使用反射清空引用"></a>二、使用反射清空引用</h2><p>内存泄露是由于webview持有activity引用导致的，那么可不可以利用反射的特性把它持有的一你用清空呢？有人给出了这样的解决方案：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">	public void setConfigCallback(WindowManager windowManager) &#123;</div><div class="line">    try &#123;</div><div class="line">        Field field = WebView.class.getDeclaredField(&quot;mWebViewCore&quot;);</div><div class="line">        field = field.getType().getDeclaredField(&quot;mBrowserFrame&quot;);</div><div class="line">        field = field.getType().getDeclaredField(&quot;sConfigCallback&quot;);</div><div class="line">        field.setAccessible(true);</div><div class="line">        Object configCallback = field.get(null);</div><div class="line"></div><div class="line">        if (null == configCallback) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        field = field.getType().getDeclaredField(&quot;mWindowManager&quot;);</div><div class="line">        field.setAccessible(true);</div><div class="line">        field.set(configCallback, windowManager);</div><div class="line">    &#125; catch(Exception e) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在Activity中调用上面的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void onCreate(Bundle savedInstanceState) &#123;								super.onCreate(savedInstanceState);</div><div class="line">		setConfigCallback((WindowManager)getApplicationContext().getSystemService(Context.WINDOW_SERVICE));</div><div class="line">&#125;</div><div class="line">	</div><div class="line">public void onDestroy() &#123;</div><div class="line">    setConfigCallback(null);</div><div class="line">    super.onDestroy();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是该方法并不是一劳永逸的，随着SDK的升级，很可能就不好用了。</p>
<h2 id="三、开启新进程"><a href="#三、开启新进程" class="headerlink" title="三、开启新进程"></a>三、开启新进程</h2><p>在webview中开启新进程运行它，关闭的时候直接退出进程，也不需要关心什么持有不持有了，毕竟连进程都被杀死了。这个方法目前来讲是比较简单粗暴但是又很有效果的做法。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/12/WebView的内存泄露/" class="archive-article-date">
  	<time datetime="2016-12-11T16:22:27.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-12</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Dagger2之Scope、SubComponent" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/11/Dagger2之Scope、SubComponent/">Dagger2（2）Scope、SubComponent</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Dagger2学习（二）–Scope、SubCompontent</p>
<p>除了Module、Provides、Compontent、Qualifier以外，Dagger2还有两个重要的概念：Scope和SubCompontent。</p>
<p>##一、Scope<br>一般在Module和Compontent前面都会加上@Singleton，这表示Dagger里的Scope的概念。这个概念主要是为了解决对象生命周期的问题。联想一下android开发的日常，activity的一堆生命周期方法，各种application级别的单例，用户登录状态等等，Scope跟这些概念不谋而合。<br>@singleton是Dagger框架定义的唯一的Scope，我们可以定义自己的Scope。<br>以下是@singleton的源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Scope</div><div class="line">@Documented</div><div class="line">@Retention(RUNTIME)</div><div class="line">public @interface Singleton&#123;&#125;</div></pre></td></tr></table></figure>
<p>我们可以定义自己的Scope，比如定义一个跟Activity生命周期相同的Scope：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Scope</div><div class="line">@Documented</div><div class="line">@Retention(RUNTIME)</div><div class="line">public @interface PerActivity&#123;&#125;</div></pre></td></tr></table></figure>
<p>@Scope：注明是Scope<br>@Documented：标记在文档<br>@Retention（RUNTIME）：指定注解的解析时机，这里是运行时级别<br>那么为什么要自己定义Scope呢？是不是定义一个PerActivity的scope就可以完美实现和activity一样的生命周期了？当然没有那么神奇。实际上，并不是只有@Singleton注解的compontent产生的依赖才是单例，只要使用了scope注解，就都是单例的，只要不使用，就是每次都生成新的实例。Dagger框架不会帮你管理依赖的生命周期，需要开发者自己来控制。说白了，使用了PerActivity的scope以后，要在宿主activity的onCreate方法和onDestroy方法里控制compontent的生命周期，好坑。。。可是为什么还要大费周折的自定义scope呢？原因有二：</p>
<ul>
<li>1.作为标识，提高可读性，告诉开发者每一个依赖应该怎么组织管理。</li>
<li>2.管理Compontent之间的组织关系。<br>第二条暂时按下不表，从第一条来看，我认为scope带有一定的注释的作用，它可以告诉开发者，你现在用的这个依赖应该在什么产生，在什么时候应该销毁掉。<br>这就是Scope的意义。<h2 id="二、SubCompontent"><a href="#二、SubCompontent" class="headerlink" title="二、SubCompontent"></a>二、SubCompontent</h2>当一个Compontent不能满足你的需求时，你需要对它进行扩展。一种办法是使用Component(dependencies=××.classs)。另外一种是使用@Subcomponent，Subcomponent用于拓展原有component。同时，这将产生一种副作用——子component同时具备两种不同生命周期的scope。子Component具备了父Component拥有的Scope，也具备了自己的Scope。<br>需要注意的是：两个拥有依赖关系的Compontent不能拥有相同的生命周期。为啥？看<a href="https://github.com/google/dagger/issues/107#issuecomment-71073298" target="_blank" rel="external">Jake Wharton的解释</a>：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Component1 c1 = Dagger_Component1.create();</div><div class="line">Component2 c2_a = Dagger_Component2.builder().component1(c1).build();</div><div class="line">Component2 c2_b = Dagger_Component2.builder().component1(c1).build();</div></pre></td></tr></table></figure>
<p>先解释一下第2行代码：这里Component2依赖了Component1，使用的是Component(dependencies=××.classs)的方式，在创建Component2的实例时，需要调用component1()方法。<br>好了，分析一下上面的代码：Component2依赖于Component1，并且两者的scope相同，那么Component2中没有的实例必须在Component1中有，假设这个实例是v（不一定只有一个），那么c1中拥有唯一的v；而c2_a和c2_b是component2的不同实例，他们应该拥有两个不同的实例v，前后矛盾，这么做打破了scope的作用范围，因此，在dagger中是不允许这么做的，也表明了scope的意义之一：管理Component之间的组织。“This is by design.”</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/11/Dagger2之Scope、SubComponent/" class="archive-article-date">
  	<time datetime="2016-12-11T10:00:50.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-11</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Dagger2之基本概念" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/11/Dagger2之基本概念/">Dagger2 基本概念</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Dagger2学习之基本概念<br>Dagger2是一个依赖注入（Dependency Injection简称DI）框架。它是Square公司的Dagger项目下的一个分支，由Google维护。依赖注入的概念，相信接触过spring开发的都比较熟悉，简单来说就是一个类A的生成如果需要另一个类B的实例，就说A依赖于B。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class A&#123;</div><div class="line">	B b；</div><div class="line">	A()&#123;</div><div class="line">		b = new B();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的实现方式没有任何注入，创建A时需要在A的构造函数内部创建一个B类，这么做的缺点是A和B的耦合太严重，如果B的构造函数变了，那么就需要修改A的构造函数。可以这样改进：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class A&#123;</div><div class="line">	B b；</div><div class="line">	A(B b)&#123;</div><div class="line">		this.b = b;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码实现了手动的注入，解除了A和B的耦合，起码B的代码有修改时不需要修改A了。但是手动注入在大型项目中也是一个很麻烦的过程，一堆无意义的重复劳动，还有依赖顺序的问题，如果B再依赖于C，C依赖于D，那么创建顺序也很容易把人整懵。依赖注入框架就可以帮我们做这个事，通过自动生成的代码来把要依赖的类注入到需要依赖的类中，这就是为什么需要依赖注入的原因。<br>为什么选择Dagger2呢？因为Dagger2是通过apt插件在编译期生成代码，通过注解处理器生成特定规则的代码，比一般注解框架的运行时注解性能上要强很多，减少了很多工作量。<br>下面简单介绍一下Dagger2中的几个概念.</p>
<ul>
<li>.@Inject<br>@inject注解用来标注一个类中要依赖的其他类，也用来标注一个被依赖的类的构造函数。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class A&#123;</div><div class="line">	@Inject</div><div class="line">	B b；</div><div class="line">	A()&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class B&#123;</div><div class="line">	@Inject</div><div class="line">	B()&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过@Inject注解，就可以把A要依赖的成员变量b和B类的构造函数对应起来。</p>
<ul>
<li>.@Component<br>Component注解类是一个接口或者抽象类，它用来连接依赖类和被依赖类。在当前的例子中，Component类需要引用A的实例，它会去查找A中标注了@Inject的成员，然后会查找该成员中标注了@Inject的构造函数，找到后就会初始化该成员并赋值，因此Component也可以叫它注解器（Injector）。</li>
<li>.@Module<br>假设我们使用@Inject的方式进行注入，会面临一个问题，当需要注入一个第三方类库的类实例时，我们不可能去给对应的构造函数添加@Inject注解，此时@Module就派上用场了。使用@Module标注的类里提供一些创建类实例的方法，可以把第三方类库的类实例的生成方法生命在Module里，这样Module就成了一个提供类实例的类，然后还是通过Component来进行连接另一端的需要依赖类B的类A，这就是Component的另一个功能：管理Module。Component的modules属性可以把Module加入到Component中。</li>
<li>@Provides<br>Component怎么跟Module关联起来呢？这就用到@Provides标注了，将Module中生产类实例的方法用@Provides标注，Component就会在找到类A中的标注的@Inject的成员b以后到它的module中寻找对应的@provides的创建B实例的方法了。<br>注意Component创建类实例有两个方法，一是通过@Inject标注的构造方法，二是通过Module中@Provides标注的方法创建。这两种方法是有优先级的，Component会优先从Module中查找，如果找到了对应方法则会停止查找并创建实例，如果没找到才会到被依赖类中查找@Inject标注的构造函数。</li>
<li>限定符（Qualifier）<br>还是之前的例子，如果A依赖于B，并对b成员标注了@Inject，而B中有多个标注@Inject的构造函数时，Component该选择哪个呢？此时就用到限定符了。这种情况下可以给不同的构造方法用标识进行区分，相当于给每个方法一个索引，同时对应于A类中的成员b，也需要使用该标识来进行标注，这样就可以一一对应起来了。这个标识就是Qualifier注解。<br>今天先介绍这么多，Dagger2是一个非常好用的框架，学习起来比较难理解，以后会通过一些例子来边学习边总结。</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/11/Dagger2之基本概念/" class="archive-article-date">
  	<time datetime="2016-12-11T09:58:27.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-11</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Gradle学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/11/Gradle学习笔记/">Gradle学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#Gradle学习笔记（一）</p>
<p>Gradle是android开发中引入的全新的构建系统。<br>    它使用领域驱动语言（DSL）来描述构建逻辑，使用groovy来编写构建脚本，可以方便的定制构建逻辑，具有非常良好的扩展性，并且我们可以非常容易的使用一些可重用的组件来组成构建。你可以随心所欲的来控制、扩展你的构建过程。<br>    Gradle里有两个最基本的概念，任何东西都是基于这两个基础概念：</p>
<ul>
<li>Project</li>
<li><p>Task<br>每一个构建都由一个或多个Project构成，Project理解的不是很清楚，官方文档的解释是：“ 一个 project 到底代表什么依赖于你想用 Gradle 做什么. 举个例子, 一个 project 可以代表一个 JAR 或者一个网页应用. 它也可能代表一个发布的 ZIP 压缩包, 这个 ZIP 可能是由许多其他项目的 JARs 构成的. 但是一个 project 不一定非要代表被构建的某个东西. 它可以代表一件要做的事, 比如部署你的应用.”我理解在android开发中，一个Project就代表我们要构建的一个应用。<br>每一个Project由一个或多个Task构成，Task是一些更加细化的构建步骤，例如复制文件，签名安装包等。Project为Task提供了上下文环境。<br>gradle运行时会在当前目录中查找一个名叫build.gradle的文件，称之为构建脚本，脚本里定义了Projects和他的Tasks。<em>运行构建时，分为两步：配置阶段和执行阶段。</em><br><strong>创建Task:</strong><br>1.</p>
<pre><code>task helloWorld &amp;lt;&amp;lt; {
   println &quot;Hello World!&quot;
}
</code></pre><p>2.</p>
<pre><code>task helloWorld {
   doLast {
      println &quot;Hello World&quot;}
}
</code></pre><p>3.</p>
<pre><code>task helloWorld {
   println &quot;Hello World!&quot;
}
</code></pre><p>4.</p>
<pre><code>task hello(dependsOn:HelloWorld) &amp;lt;&amp;lt; {
    println &apos;hello&apos;
}
</code></pre><p>5.</p>
<pre><code>task copy(type: Copy) {
   from &apos;resources&apos;
   into &apos;target&apos;
}
</code></pre><p>通过调用Project的Task()方法来创建任务，以上1和2是等价的，doLast表示在该Task的最后加入执行代码，&lt;&lt;是doLast的快捷写法。3是直接创建了一个任务，那1、2和3有什么区别呢？就是他们执行的阶段不同，3是直接在配置区域声明的任务，因此它在配置阶段就被执行，而1和2是在配置完成后才打印“Hello World”，因此只有我们主动的调用才会执行。任务4给hello任务增加了一个依赖，表示在执行4时，要先执行其依赖的HelloWorld任务，也可以在Task定义之后再声明依赖：<code>hello.dependsOn HelloWorld</code>。对于任务5，Copy是一个内置的默认Task，它有多种重载形式，如果想直接用这个功能，我们可以配置一个Task，就像任务5做的那样，它表示本身是一个Copy任务，而且传入了两个参数，调用copy时实际上是调用了Copy任务，而且copy任务内部的代码是在配置阶段执行的，在执行阶段才会真正调用Copy。<br><strong>闭包</strong><br>闭包（Closure）是一段单独的代码块，它可以接受参数，返回值，或者赋值给一个变量，最关键的是他可以作为参数传递给其他方法，这样做有一个很大的好处就是可以解耦一些执行逻辑。闭包会在被调用的时候执行，而不是创建时。</p>
</li>
</ul>
<pre><code>def hello = { println &apos;Hello world!&apos; }
//执行闭包
hello()
</code></pre><p>以上代码创建了一个闭包，紧接着又调用了他，这时会打印出“Hello World!”。<br>把闭包hello当做一个参数传递：<code>method(hello)</code>，<br>如果闭包是方法最后一个参数，可以省略掉括号：<code>method hello</code>，<br>或者使用内联的闭包：<code>method({println &#39;Hello world!&#39;})</code>，<br>接受多个参数：<code>method(arg1, { println ‘Hello World’ })</code>，<br>如果闭包是最后一个参数，可以把他从括号中提出来：<code>method(arg1) { println ‘Hello World’ }</code>，<br>最后一个看上去好熟悉的样子。。。<br>闭包还可以直接使用当前上下文的变量：<br>    def word = ‘Hello World!’<br>    def closure = {println word}<br>    closure()<br>执行后将打印出“Hello World!”。<br>闭包还有一个重要的功能是就是delegate机制。简单说就是我们可以让闭包中执行代码的作用对象设置成任意其他对象：<br>    def closure = {println name}<br>    Person person = new Person()<br>    closure.setDelegate(person)<br>    class Person {<br>        def name = “hello”；<br>    }<br>上面的代码执行后打印出”hello“。定义closure时，name变量是不存在的，但是当设置了delegete是person对象时，闭包的作用对象就成了person，而person是存在name变量的，因此打印出了person的name。    </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/11/Gradle学习笔记/" class="archive-article-date">
  	<time datetime="2016-12-11T09:47:08.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-11</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-React-Native之Navigator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/11/React-Native之Navigator/">React Native之Navigator</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="React-Native-之Navigator"><a href="#React-Native-之Navigator" class="headerlink" title="React Native 之Navigator"></a>React Native 之Navigator</h1><p>在React Native里，可以使用Navigator和NavigatorIOS来实现页面间的导航。导航器建立了一个路由栈，用来弹出或者推入一个路由状态。类似于Android中的Activity Task。NavigatorIOS使用了iOS中的UINavigationController类，而Navigator是完全使用js重写的一个功能类似的React组件，所以Navigator可以兼容Android和iOS，而NavigatorIOS只能用于iOS。二者的主要区别在于：<br><strong>Navigator</strong>:</p>
<ul>
<li>完全使用js语言开发，可以通过js进行定制。</li>
<li>React Native团队正在积极的开发维护。</li>
<li>兼容iOS和Android。</li>
<li>包含一个简单的导航栏Navigator.NavigationBar。</li>
<li>可以通过向navigationBar传递属性来提供自己的导航栏。</li>
</ul>
<p><strong>NavigationIOS</strong></p>
<ul>
<li>使用UINavigationController实现，不利于扩展定制。</li>
<li>封装了UIKit，和原生应用表现一致，但是只能使用苹果开发好的动画和行为。</li>
<li>默认的导航栏不是React Native视图组件，因此只能稍微修改样式。</li>
</ul>
<p>既然要用React Native开发通用两个平台的app，那我们当然要使用Navigator了。</p>
<h2 id="简单跳转"><a href="#简单跳转" class="headerlink" title="简单跳转"></a>简单跳转</h2><p>这是一个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;Navigator</div><div class="line">   initialRoute=&#123;&#123; name: &apos;XSLMenu&apos;, component: XSLMenu &#125;&#125;</div><div class="line">   configureScene=&#123;() =&gt; &#123;</div><div class="line">     if (Platform.OS === &apos;android&apos;) &#123;</div><div class="line">       return Navigator.SceneConfigs.FadeAndroid;</div><div class="line">     &#125;</div><div class="line">     return Navigator.SceneConfigs.FloatFromBottom;</div><div class="line">   &#125;&#125;</div><div class="line">   renderScene=&#123;(route, navigator) =&gt; &#123;</div><div class="line">     const Com = route.component;</div><div class="line">     return &lt;Com &#123;...route.params&#125; navigator=&#123;navigator&#125; /&gt;</div><div class="line">   &#125;&#125;</div><div class="line"> /&gt;</div></pre></td></tr></table></figure>
<p><code>initialRoute={...}</code>指定了默认的页面，我是在启动app后的第一个Component上添加这些代码，component参数就是指定我要跳转到的页面，也就是启动app后实际看到的第一个页面。<br><code>configureScene={...}</code>指定页面跳转的动画，这里区分了一下Android和iOS的风格。<br><code>renderScene={...}</code>，这里有两个参数route和navigator。通过打印发现route里就是我们传递的name和component两个东西，navigator是Navigator的一个对象，它就是我们在以后的页面中跳转时需要用到的push()、pop()等方法的提供者。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">const Com = route.component;</div><div class="line">   return &lt;Com &#123;...route.params&#125; navigator=&#123;navigator&#125; /&gt;</div></pre></td></tr></table></figure></p>
<p>这里传了两个参数，<br><code>{...route.params}</code> 和 <code>{navigator}</code>，<br><code>{navigator}</code>就是之前说的后面的页面要使用的Navigator对象，那<code>{...route.params}</code>是什么呢？…这个语法是把route.params里的每个key作为props的属性传递给下个Component。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">navigator.push(&#123;</div><div class="line">name: &apos;Detail&apos;,</div><div class="line">component: DetailComponent,</div><div class="line">params: &#123;</div><div class="line">    id: this.state.id</div><div class="line">    name: this.state.name</div><div class="line">&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>就是把id和name属性都传递给了DetailComponent。<br>对于跳转到的页面，怎么接受之前页面传递的参数呢？很简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">props:&#123;</div><div class="line">   	navigator:Navigator;</div><div class="line">	&#125;</div><div class="line">let nav = this.props.navigator</div><div class="line">//nav.pop()</div></pre></td></tr></table></figure>
<p>这样就实现了页面之间的跳转、返回。</p>
<p>##Android物理返回键处理<br>对于Android来讲，返回上个页面有两种方式，点击导航栏的返回或者点手机的物理返回键，下面来处理Android物理返回键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">const &#123; navigator &#125; = this.props;    BackAndroid.addEventListener(&apos;hardwareBackPress&apos;, () =&gt; &#123;</div><div class="line"> if (navigator &amp;&amp; navigator.getCurrentRoutes().length &gt; 1) &#123;</div><div class="line">   navigator.pop();</div><div class="line">   return true;</div><div class="line"> &#125;</div><div class="line"> return false;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>依然是使用navigator对象，BackAndroid是React Native api，添加一个对物理返回键的监听即可。<br>现在实现了页面间的跳转和Android物理返回键的处理，以及在跳转到下个页面时携带一些对象。那么如果当前页面需要使用下个页面的一些对象该怎么办呢？也就是Android开发当中的startActivityForResult和onActivityResult所做的事。</p>
<p>##prams的高级用法<br>pop()方法并没有提供参数，这里要用到一个概念，把上个页面的实例或回调方法，当做参数传给当前页面，然后在当前页面操作上个页面的state。<br>一个查询用户信息的例子：<br>FirstComponent，把userid传递给第二个页面去查询user的信息，还传了一个getUser方法，方法里更新了state的user：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">constructor(props) &#123;</div><div class="line">     super(props);</div><div class="line">     this.state = &#123;</div><div class="line">         id: 2,</div><div class="line">     user: null,</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line">pressButton() &#123;</div><div class="line">let _this = this;</div><div class="line">const &#123; navigator &#125; = this.props;</div><div class="line">if(navigator) &#123;</div><div class="line">  	navigator.push(&#123;</div><div class="line">      name: &apos;SecondComponent&apos;,</div><div class="line">      component: SecondComponent,</div><div class="line">      params: &#123;</div><div class="line">          id: this.state.id,</div><div class="line">          //从SecondComponent获取user</div><div class="line">          getUser: function(user) &#123;</div><div class="line">              _this.setState(&#123;</div><div class="line">                  user: user</div><div class="line">              &#125;)</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  	&#125;);</div><div class="line">	&#125;</div><div class="line">	&#125;</div><div class="line">	render() &#123;</div><div class="line">   	if( this.state.user ) &#123;</div><div class="line">       return(</div><div class="line">           &lt;View&gt;</div><div class="line">               &lt;Text&gt;用户信息: &#123; JSON.stringify(this.state.user) &#125;&lt;/Text&gt;</div><div class="line">           &lt;/View&gt;</div><div class="line">       );</div><div class="line">   	&#125;else &#123;</div><div class="line">       return(</div><div class="line">           &lt;View&gt;</div><div class="line">               &lt;TouchableOpacity onPress=&#123;this._pressButton.bind(this)&#125;&gt;</div><div class="line">                   &lt;Text&gt;查询ID为&#123; this.state.id &#125;的用户信息&lt;/Text&gt;</div><div class="line">               &lt;/TouchableOpacity&gt;</div><div class="line">           &lt;/View&gt;</div><div class="line">       );</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二个页面获取到userid后，查询user信息并调用FirstComponent的getUser方法来刷新FirstComponent的页面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">const USER_MODELS = &#123;</div><div class="line">1: &#123; name: &apos;mot&apos;, age: 23 &#125;,</div><div class="line">2: &#123; name: &apos;晴明大大&apos;, age: 25 &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const &#123; navigator &#125; = this.props; </div><div class="line">if(this.props.getUser) &#123;</div><div class="line">	let user = USER_MODELS[this.props.id];</div><div class="line">	this.props.getUser(user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##统一的导航栏<br>对于应用而言, 需要统一的导航栏, Navigator 组件也提供导航栏的定制.只需要额外添加属性navigationBar：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">navigationBar=&#123; &lt;Navigator.NavigationBar routeMapper=&#123;NavigationBarRouteMapper&#125; /&gt;&#125;</div></pre></td></tr></table></figure>
<p>routeMapper是NavigationBarRouteMapper，标题栏路由映射器，用它来描述标题栏的左键 右键和标题。</p>
<p>​<figure class="highlight plain"><figcaption><span>NavigationBarRouteMapper = &#123;</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">// 左键</div><div class="line">LeftButton(route, navigator, index, navState) &#123;</div><div class="line">if (index &gt; 0) &#123;</div><div class="line"> return (</div><div class="line">   &lt;View &gt;</div><div class="line">     &lt;TouchableOpacity underlayColor=&quot;transparent&quot; onPress=&#123;() =&gt; &#123;if (index &gt; 0) &#123;navigator.pop()&#125;&#125;&#125; &gt;</div><div class="line">       &lt;Text&gt;</div><div class="line">         后退</div><div class="line">       &lt;/Text&gt;</div><div class="line">     &lt;/TouchableOpacity&gt;</div><div class="line">   &lt;/View&gt;</div><div class="line"> );</div><div class="line">&#125;</div><div class="line">return null</div><div class="line">&#125;,</div><div class="line">// 右键</div><div class="line">RightButton(route, navigator, index, navState) &#123;</div><div class="line">if (route.onPress) &#123;</div><div class="line"> return (</div><div class="line">   &lt;View&gt;</div><div class="line">     &lt;TouchableOpacity onPress=&#123;() =&gt; route.onPress()&#125; &gt;</div><div class="line">       &lt;Text&gt;</div><div class="line">         &#123;route.rightText || &apos;右键&apos;&#125;</div><div class="line">       &lt;/Text&gt;</div><div class="line">     &lt;/TouchableOpacity&gt;</div><div class="line">   &lt;/View&gt;</div><div class="line"> );</div><div class="line">&#125;</div><div class="line">return null;</div><div class="line">&#125;,</div><div class="line">// 标题</div><div class="line">Title(route, navigator, index, navState) &#123;</div><div class="line">return (</div><div class="line"> &lt;View&gt;</div><div class="line">   &lt;Text&gt;</div><div class="line">     应用标题</div><div class="line">   &lt;/Text&gt;</div><div class="line"> &lt;/View&gt;</div><div class="line">);</div><div class="line">&#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这样就实现了统一的导航栏。不过有一点疑问的是，是不是所有页面的左右键的动作都要写在这个mapper里，如果是的话，随着项目变大，这里的代码会越来越多，期待更好的解决方案。</p>
<p>Done。</p>
<p>```</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/11/React-Native之Navigator/" class="archive-article-date">
  	<time datetime="2016-12-11T09:41:41.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-11</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 fkaking
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">苟利国家生死已&lt;br&gt;岂因祸福避趋之</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>